---
name: publish-analysis
description: End-to-end blog post pipeline - from research question to published, distributed post with traceable numbers
arguments:
  - name: topic
    description: Research question, reform description, or bill reference (e.g., "SALT cap repeal" or "HR 1234")
    required: true
  - name: country
    description: Country code (us or uk)
    default: "us"
  - name: year
    description: Analysis year
    default: "2026"
---

# Publish Analysis: $ARGUMENTS

Generate a complete, SEO-optimized blog post from a policy reform — all numbers traceable to code, zero hard-coded values. Uses `policyengine.py` for local simulation.

## Prerequisites

Load these skills before starting:
- `blog-pipeline` — results.json schema, template syntax, chart/table catalogs
- `policyengine-writing-skill` — neutral tone, active voice, PE style
- `us-household-analysis` or `uk-household-analysis` — depending on country
- `content-generation-skill` — social images and copy

---

## Pre-Flight Checklist

Before starting:
- [ ] I will use `policyengine.py` for all simulations (not API, not policyengine-us directly)
- [ ] I will generate results.json with `source_line` and `source_url` for every value
- [ ] I will use `{{}}` template references — zero hard-coded numbers in the blog post
- [ ] I will follow policyengine-writing-skill for neutral tone and active voice
- [ ] I will generate descriptive alt text with 2-3 key data points for every chart
- [ ] I will ask the user before creating any GitHub repos or PRs

---

## Key Rules

1. **Zero hard-coded values**: Every number in the blog post comes from results.json via `{{}}` templates
2. **Every number is traceable**: `source_line` and `source_url` in results.json point to the exact code
3. **Neutral language**: Describe what policies do, not whether they are good or bad (see policyengine-writing-skill)
4. **No iframes**: Charts are static `<img>` tags from GitHub Pages with descriptive alt text
5. **Active voice**: "The reform reduces poverty by 3.2%" not "Poverty is reduced by 3.2%"
6. **Quantitative precision**: "$15.2 billion" not "significant cost"
7. **Sentence case headings**: "Budgetary impact" not "Budgetary Impact"
8. **Show calculations**: Spell out how derived values are computed

---

## Phase 1: Define the Reform

1. **Parse the topic** — identify what policy change to analyze
2. **Ask clarifying questions** if needed:
   - What specific parameters change?
   - What is the baseline (current law, TCJA extension, etc.)?
   - What year to analyze?
   - US or UK?
3. **Identify the PE parameter paths** for the reform:
   ```python
   from policyengine.tax_benefit_models.{country} import {country}_latest
   # Search parameter names matching the topic
   ```

---

## Phase 2: Create Analysis Directory

Create a directory in the analysis-notebooks repo (or a new repo if user prefers):

```
{topic-slug}/
  analysis.py          # Full simulation + results.json generation
  results.json         # Generated by analysis.py
  charts/              # Generated by analysis.py
  requirements.txt     # policyengine, plotly, kaleido
  README.md            # How to reproduce
```

Write requirements.txt:
```
policyengine>=0.1.0
plotly>=5.15.0
kaleido>=0.2.1
```

---

## Phase 3: Spawn Specialist Agents

Spawn agents sequentially — each phase depends on the previous.

### Agent 1: Analysis Writer

Invoke **analysis-writer** agent:
```
Write analysis.py for the following reform:

- Reform: {parsed reform description}
- Country: {us/uk}
- Year: {year}
- Parameter paths: {identified paths from Phase 1}
- Analysis type: {microsimulation / household / both}
- Output directory: {topic-slug}/
- Repo slug: PolicyEngine/{repo-name}

Follow the instructions in agents/content/analysis-writer.md.
Use policyengine.results.tracked_value() for every value.
Use policyengine.results.ResultsJson to validate before writing.
Use policyengine.utils.plotting.format_fig() for chart styling.
```

**Verify before proceeding:**
- `results.json` exists and is valid JSON
- All values have `source_line` and `source_url`
- `charts/*.png` files exist
- Source URLs point to real line numbers

### Agent 2: Blog Writer

Invoke **blog-writer** agent:
```
Write a blog post for the following analysis:

- results.json path: {topic-slug}/results.json
- Reform description: {parsed reform description}
- Country: {us/uk}
- Output path: {topic-slug}/post.md

Follow the instructions in agents/content/blog-writer.md.
Every number must be a {{}} reference — zero hard-coded values.
Use neutral tone, active voice, sentence case headings.
```

**Verify before proceeding:**
- Every `{{name}}` matches a key in results.json
- No raw numbers outside `{{}}`
- Methodology section exists with repo link

### Agent 3: Pipeline Validator

Invoke **pipeline-validator** agent:
```
Validate the full pipeline output:

- results.json path: {topic-slug}/results.json
- Blog post path: {topic-slug}/post.md
- Charts directory: {topic-slug}/charts/

Follow the instructions in agents/content/pipeline-validator.md.
Run all 9 checks and produce the validation report.
```

**If validator reports failures:**
- Schema/reference errors are **blockers** — fix before proceeding
- Language/style issues are **warnings** — fix if possible, note if not

---

## Phase 4: Create Posts Entry

Add an entry to `posts.json` in policyengine-app-v2:

```json
{
  "title": "...",
  "description": "...",
  "date": "YYYY-MM-DD",
  "tags": ["{country}", "policy"],
  "authors": ["..."],
  "filename": "{topic-slug}.md",
  "image": "{topic-slug}.png",
  "analysis_repo": "PolicyEngine/{repo-name}"
}
```

The `analysis_repo` field triggers the resolve-posts build step.

---

## Phase 5: Generate Social Content

Use the content-generation skill to create:

1. **Social sharing image** (1200x630) using the social-image template
2. **Twitter/X post** — key finding + image + link
3. **LinkedIn post** — more context, professional tone

Social copy must follow the same neutral tone as the blog post:

**Correct:**
```
Repealing the SALT cap would cost $15.2 billion in 2026.
The top income decile receives 42% of total benefits.

Full analysis: [link]
```

**Wrong:**
```
BREAKING: SALT cap repeal is a massive giveaway to the wealthy!
This shocking analysis reveals who really benefits.
```

---

## Phase 6: Create PRs

### Analysis repo
```bash
cd {topic-slug}
git add .
git commit -m "Add {topic} analysis with results.json and charts"
git push origin main
```

### Blog post PR (policyengine-app-v2)
Use `/create-pr` command for proper PR creation with CI check waiting.

---

## Phase 7: Verify

Before marking as done, run through this checklist:

| Check | How to verify |
|-------|---------------|
| All `{{}}` refs resolve | Search markdown for `{{` — each must match a key in results.json |
| Charts load | curl each GitHub Pages chart URL — expect 200 |
| Alt text is descriptive | Each alt starts with chart type and includes 2-3 data points |
| No hard-coded numbers | Search markdown for raw digits — each should be inside `{{}}` |
| Neutral language | No "unfortunately", "significant", "massive", "dramatic" |
| Active voice | No "is reduced by", "are projected by" |
| Sentence case headings | No title case in H2/H3 headers |
| Source links work | `source_url` values return 200, point to correct lines |
| Methodology section | Specifies model version, dataset, year, and assumptions |

---

## Phase 8: Distribution Checklist

After merge and deploy:

- [ ] Post to Twitter/X with key finding + image
- [ ] Post to LinkedIn with key finding + image
- [ ] Send to newsletter list (if applicable)
- [ ] Direct outreach to bill sponsors (if bill analysis)
- [ ] Pitch to relevant reporters
- [ ] Log in CRM
- [ ] Confirm GA4 events firing

---

## Error Handling

| Problem | Cause | Fix |
|---------|-------|-----|
| Dataset not found | HDF5 file not available locally | Download from HuggingFace: `hf://policyengine/policyengine-us-data/enhanced_cps_2024.h5` |
| Memory issues | Microsimulation loads ~60k households | Ensure 8GB+ RAM available. Use `simulation.ensure()` for caching |
| Chart generation fails | kaleido not installed | `pip install kaleido` or note in results.json that charts need manual generation |
| Unresolvable `{{ref}}` | Key mismatch between markdown and results.json | Fix spelling or add missing key to results.json |
| Stale source lines | Code changed after generating results.json | Re-run analysis.py to regenerate results.json |
| Validator fails | Schema or reference errors | Fix blockers before proceeding; warnings can be noted |

---

Start by parsing the topic, then proceed through all phases.
