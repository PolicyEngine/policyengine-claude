---
name: publish-analysis
description: End-to-end blog post pipeline - from research question to published, distributed post with traceable numbers
arguments:
  - name: topic
    description: Research question, reform description, or bill reference (e.g., "SALT cap repeal" or "HR 1234")
    required: true
  - name: country
    description: Country code (us or uk)
    default: "us"
  - name: year
    description: Analysis year
    default: "2026"
---

# Publish Analysis: $ARGUMENTS

Generate a complete, SEO-optimized blog post from a policy reform — all numbers traceable to code, zero hard-coded values. Uses `policyengine.py` for local simulation.

## Prerequisites

Load these skills before starting:
- `blog-pipeline` — results.json schema, template syntax, policyengine.py patterns
- `policyengine-writing-skill` — neutral tone, active voice, PE style
- `policyengine-analysis-skill` — simulation patterns, chart types
- `content-generation-skill` — social images and copy

---

## Pre-Flight Checklist

Before starting:
- [ ] I will use `policyengine.py` for all simulations (not API, not policyengine-us directly)
- [ ] I will generate results.json with `source_line` and `source_url` for every value
- [ ] I will use `{{}}` template references — zero hard-coded numbers in the blog post
- [ ] I will follow policyengine-writing-skill for neutral tone and active voice
- [ ] I will generate descriptive alt text with 2-3 key data points for every chart
- [ ] I will ask the user before creating any GitHub repos or PRs

---

## Key Rules

1. **Zero hard-coded values**: Every number in the blog post comes from results.json via `{{}}` templates
2. **Every number is traceable**: `source_line` and `source_url` in results.json point to the exact code
3. **Neutral language**: Describe what policies do, not whether they are good or bad (see policyengine-writing-skill)
4. **No iframes**: Charts are static `<img>` tags from GitHub Pages with descriptive alt text
5. **Active voice**: "The reform reduces poverty by 3.2%" not "Poverty is reduced by 3.2%"
6. **Quantitative precision**: "$15.2 billion" not "significant cost"
7. **Sentence case headings**: "Budgetary impact" not "Budgetary Impact"
8. **Show calculations**: Spell out how derived values are computed

---

## Phase 1: Define the Reform

1. **Parse the topic** — identify what policy change to analyze
2. **Ask clarifying questions** if needed:
   - What specific parameters change?
   - What is the baseline (current law, TCJA extension, etc.)?
   - What year to analyze?
   - US or UK?
3. **Identify the PE parameter paths** for the reform:
   ```python
   from policyengine.tax_benefit_models.{country} import {country}_latest
   # Search parameter names matching the topic
   ```

---

## Phase 2: Create Analysis Repo

1. **Create a new GitHub repo** under PolicyEngine org:
   ```bash
   gh repo create PolicyEngine/{topic-slug} --public --clone
   cd {topic-slug}
   ```

2. **Create the repo structure:**
   ```
   analysis.py          # Full simulation + results.json generation
   results.json         # Generated by analysis.py
   charts/              # Generated by analysis.py
   requirements.txt     # policyengine, plotly, kaleido
   README.md            # How to reproduce
   .github/workflows/pages.yml  # Chart deployment to GitHub Pages
   ```

3. **Write requirements.txt:**
   ```
   policyengine>=0.1.0
   plotly>=5.15.0
   kaleido>=0.2.1
   ```

4. **Write .github/workflows/pages.yml** for auto-deploying charts to GitHub Pages.

5. **Enable GitHub Pages** on the repo (Settings > Pages > GitHub Actions).

---

## Phase 3: Write and Run analysis.py

Write a Python script using `policyengine.py` that:
1. Defines the reform using `Policy`, `Parameter`, `ParameterValue`
2. Loads the dataset (`PolicyEngineUSDataset` or `PolicyEngineUKDataset`)
3. Runs baseline and reform simulations via `Simulation.run()`
4. Computes all outputs using built-in classes (`DecileImpact`, `Poverty`, `Aggregate`, `ChangeAggregate`)
5. Generates chart PNGs using Plotly with PE brand colors
6. Writes results.json with source line tracking via `inspect`

### analysis.py structure:

```python
import json, os, inspect, datetime
from policyengine.core import Simulation, Policy, Parameter, ParameterValue
from policyengine.tax_benefit_models.us import PolicyEngineUSDataset, us_latest
from policyengine.outputs.aggregate import Aggregate, AggregateType
from policyengine.outputs.decile_impact import DecileImpact
from policyengine.outputs.poverty import Poverty
from policyengine.outputs.change_aggregate import ChangeAggregate, ChangeAggregateType
import plotly.graph_objects as go
import plotly.io as pio

REPO = "PolicyEngine/{topic-slug}"
YEAR = 2026

# 1. Define reform
param = Parameter(name="...", tax_benefit_model_version=us_latest, data_type=float)
pv = ParameterValue(parameter=param, start_date=datetime.date(2026,1,1),
                    end_date=datetime.date(2026,12,31), value=NEW_VALUE)
policy = Policy(name="Reform Name", parameter_values=[pv])

# 2. Load dataset
dataset = PolicyEngineUSDataset(name="enhanced_cps_2024",
                                 filepath="path/to/enhanced_cps_2024.h5", year=YEAR)

# 3. Run simulations
baseline = Simulation(dataset=dataset, tax_benefit_model_version=us_latest)
baseline.run()

reform = Simulation(dataset=dataset, tax_benefit_model_version=us_latest, policy=policy)
reform.run()

# 4. Extract results using built-in output classes
decile = DecileImpact(baseline_simulation=baseline, reform_simulation=reform,
                      variable="household_net_income")
decile.run()

poverty = Poverty(baseline_simulation=baseline, reform_simulation=reform)
poverty.run()

# 5. Direct variable access for custom analysis
baseline_net = baseline.output_dataset.data.household["household_net_income"]
reform_net = reform.output_dataset.data.household["household_net_income"]
weights = baseline.output_dataset.data.household["household_weight"]

# 6. Generate charts
fig = go.Figure(...)
os.makedirs("charts", exist_ok=True)
pio.write_image(fig, "charts/distributional.png", width=1200, height=600, scale=2)

# 7. Build results.json with source tracking
results = {
    "metadata": {"title": "...", "repo": REPO, ...},
    "values": {
        "budget_impact": {
            "value": budget_impact,
            "display": format_currency(budget_impact),
            "source_line": inspect.currentframe().f_lineno,
            "source_url": f"https://github.com/{REPO}/blob/main/analysis.py#L{line}",
        }
    },
    "tables": {...},
    "charts": {...},
}
with open("results.json", "w") as f:
    json.dump(results, f, indent=2)
```

### Run the script:
```bash
pip install -r requirements.txt
python analysis.py
```

### Verify outputs:
- `results.json` exists with all expected keys
- `charts/*.png` files exist and look correct
- All `source_line` values point to real code lines

---

## Phase 4: Write Blog Post

1. **Draft the blog post** as a markdown file using `{{}}` template references:

   ```markdown
   The [reform name] would [verb] {{budget_impact}} per year.

   ## Budgetary impact

   {{table:distributional}}

   {{chart:distributional}}

   ## Household examples

   {{table:household_examples}}

   ## Poverty impact

   The reform would change the poverty rate by {{poverty_change}}.

   ## Methodology

   This analysis uses PolicyEngine's microsimulation model with the
   Enhanced CPS 2024 dataset. All calculations are open source and
   reproducible. [View the analysis code](https://github.com/REPO).
   ```

2. **Follow the writing skill rules:**

   **✅ Correct (neutral, active, quantitative):**
   ```
   Repealing the SALT cap costs {{budget_impact}} in {{year}}.
   The top income decile receives {{top_decile_share}} of total benefits.
   ```

   **❌ Wrong (value judgments, passive, vague):**
   ```
   Repealing the SALT cap would unfortunately cost a significant amount.
   The wealthiest households receive a disproportionate share of benefits.
   ```

3. **Write chart alt text** — descriptive, includes key data points, 1-3 sentences.

4. **Validate all references** — every `{{name}}` in the markdown must exist in results.json.

---

## Phase 5: Create Posts Entry

Add an entry to `posts.json` in policyengine-app-v2:

```json
{
  "title": "...",
  "description": "...",
  "date": "YYYY-MM-DD",
  "tags": ["{country}", "policy"],
  "authors": ["..."],
  "filename": "{topic-slug}.md",
  "image": "{topic-slug}.png",
  "analysis_repo": "PolicyEngine/{topic-slug}"
}
```

The `analysis_repo` field triggers the resolve-posts build step.

---

## Phase 6: Generate Social Content

Use the content-generation skill to create:

1. **Social sharing image** (1200x630) using the social-image template
2. **Twitter/X post** — key finding + image + link
3. **LinkedIn post** — more context, professional tone

Social copy must follow the same neutral tone as the blog post:

**✅ Correct:**
```
Repealing the SALT cap would cost $15.2 billion in 2026.
The top income decile receives 42% of total benefits.

Full analysis: [link]
```

**❌ Wrong:**
```
BREAKING: SALT cap repeal is a massive giveaway to the wealthy!
This shocking analysis reveals who really benefits.
```

---

## Phase 7: Create PRs

### Analysis repo
```bash
cd {topic-slug}
git add .
git commit -m "Add {topic} analysis with results.json and charts"
git push origin main
```

### Blog post PR (policyengine-app-v2)
Use `/create-pr` command for proper PR creation with CI check waiting.

---

## Phase 8: Verify

Before marking as done, run through this checklist:

| Check | How to verify |
|-------|---------------|
| All `{{}}` refs resolve | Search markdown for `{{` — each must match a key in results.json |
| Charts load | curl each GitHub Pages chart URL — expect 200 |
| Alt text is descriptive | Each alt starts with chart type and includes 2-3 data points |
| No hard-coded numbers | Search markdown for raw digits — each should be inside `{{}}` |
| Neutral language | No "unfortunately", "significant", "massive", "dramatic" |
| Active voice | No "is reduced by", "are projected by" |
| Sentence case headings | No title case in H2/H3 headers |
| Source links work | `source_url` values return 200, point to correct lines |
| Methodology section | Specifies model version, dataset, year, and assumptions |

---

## Phase 9: Distribution Checklist

After merge and deploy:

- [ ] Post to Twitter/X with key finding + image
- [ ] Post to LinkedIn with key finding + image
- [ ] Send to newsletter list (if applicable)
- [ ] Direct outreach to bill sponsors (if bill analysis)
- [ ] Pitch to relevant reporters
- [ ] Log in CRM
- [ ] Confirm GA4 events firing

---

## Error Handling

| Problem | Cause | Fix |
|---------|-------|-----|
| Dataset not found | HDF5 file not available locally | Download from HuggingFace: `hf://policyengine/policyengine-us-data/enhanced_cps_2024.h5` |
| Memory issues | Microsimulation loads ~60k households | Ensure 8GB+ RAM available. Use `simulation.ensure()` for caching |
| Chart generation fails | kaleido not installed | `pip install kaleido` or note in results.json that charts need manual generation |
| Unresolvable `{{ref}}` | Key mismatch between markdown and results.json | Fix spelling or add missing key to results.json |
| Stale source lines | Code changed after generating results.json | Re-run analysis.py to regenerate results.json |

---

Start by parsing the topic, then proceed through all phases.
